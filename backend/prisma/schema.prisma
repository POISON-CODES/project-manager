generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                  String     @id @default(uuid())
  email               String     @unique
  name                String
  phoneNumber         String?    @unique
  avatarUrl           String?
  role                UserRole   @default(MEMBER)
  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt
  status              UserStatus @default(APPROVED)
  comments            Comment[]
  uploadedDocs        Document[]
  ownedProjects       Project[]  @relation("ProjectOwner")
  stakeholderProjects Project[]  @relation("ProjectStakeholder")
  assignedTasks       Task[]     @relation("TaskAssignee")
  activities          UserActivity[]

  @@map("users")
}

model Project {
  id             String        @id @default(uuid())
  name           String
  description    String?
  status         ProjectStatus @default(PLANNING)
  ownerId        String?
  formTemplateId String
  formData       Json
  currentStageId String?
  startDate      DateTime?
  endDate        DateTime?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  deletedAt      DateTime?
  stakeholderId  String?
  documents      Document[]
  formTemplate   FormTemplate  @relation(fields: [formTemplateId], references: [id])
  owner          User?         @relation("ProjectOwner", fields: [ownerId], references: [id])
  stakeholder    User?         @relation("ProjectStakeholder", fields: [stakeholderId], references: [id])
  stories        UserStory[]

  @@index([ownerId])
  @@index([status])
  @@map("projects")
}

model Document {
  id         String       @id @default(uuid())
  name       String
  url        String
  type       DocumentType @default(GENERAL)
  projectId  String
  uploaderId String
  createdAt  DateTime     @default(now())
  project    Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  uploader   User         @relation(fields: [uploaderId], references: [id])

  @@index([projectId])
  @@map("documents")
}

model UserStory {
  id          String      @id @default(uuid())
  title       String
  description String?
  status      StoryStatus @default(BACKLOG)
  projectId   String
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  tasks       Task[]
  project     Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("user_stories")
}

model Task {
  id          String     @id @default(uuid())
  title       String
  description String?
  status      TaskStatus @default(TODO)
  priority    Priority   @default(MEDIUM)
  dueDate     DateTime?
  storyId     String
  assigneeId  String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  comments    Comment[]
  assignee    User?      @relation("TaskAssignee", fields: [assigneeId], references: [id])
  story       UserStory  @relation(fields: [storyId], references: [id], onDelete: Cascade)
  blockedBy   Task[]     @relation("TaskDependencies")
  blocking    Task[]     @relation("TaskDependencies")

  @@index([storyId])
  @@index([assigneeId])
  @@map("tasks")
}

model Comment {
  id        String   @id @default(uuid())
  content   String
  taskId    String?
  authorId  String
  createdAt DateTime @default(now())
  author    User     @relation(fields: [authorId], references: [id])
  task      Task?    @relation(fields: [taskId], references: [id])

  @@map("comments")
}

model FormTemplate {
  id          String    @id @default(uuid())
  name        String
  version     Int       @default(1)
  schema      Json
  isActive    Boolean   @default(true)
  description String?
  projects    Project[]

  @@map("form_templates")
}

model Workflow {
  id            String           @id @default(uuid())
  name          String
  isActive      Boolean          @default(true)
  description   String?
  triggerType   String
  triggerConfig Json?
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  actions       WorkflowAction[]

  @@map("workflows")
}

model WorkflowAction {
  id         String   @id @default(uuid())
  workflowId String
  order      Int
  type       String
  config     Json
  createdAt  DateTime @default(now())
  workflow   Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@map("workflow_actions")
}

model ActionLog {
  id         String    @id @default(uuid())
  actionId   String
  status     LogStatus
  details    Json?
  executedAt DateTime  @default(now())

  @@index([status])
  @@map("action_logs")
}

model UserActivity {
  id         String   @id @default(uuid())
  userId     String
  action     String
  entityType String?
  entityId   String?
  entityName String?
  metadata   Json?
  createdAt  DateTime @default(now())
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("user_activities")
}

enum UserRole {
  ADMIN
  PROJECT_LEAD
  MEMBER
  STAKEHOLDER
}

enum UserStatus {
  PENDING
  APPROVED
  REJECTED
}

enum DocumentType {
  GENERAL
  REQ_DOC
  HANDOVER_PACKAGE
}

enum ProjectStatus {
  PLANNING
  ACTIVE
  ON_HOLD
  COMPLETED
  ARCHIVED
}

enum StoryStatus {
  BACKLOG
  READY
  IN_PROGRESS
  DONE
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  REVIEW
  DONE
  HALTED
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum LogStatus {
  SUCCESS
  FAILED
  RETRYING
  PERMANENT_FAILURE
}
